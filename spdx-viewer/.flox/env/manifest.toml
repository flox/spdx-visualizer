## Flox Environment Manifest -----------------------------------------
##
##   _Everything_ you need to know about the _manifest_ is here:
##
##   https://flox.dev/docs/reference/command-reference/manifest.toml/
##
## -------------------------------------------------------------------
# Flox manifest version managed by Flox CLI
version = 1


## Install Packages --------------------------------------------------
##  $ flox install gum  <- puts a package in [install] section below
##  $ flox search gum   <- search for a package
##  $ flox show gum     <- show all versions of a package
## -------------------------------------------------------------------
[install]
mermaid-cli.pkg-path = "mermaid-cli"
python3.pkg-path = "python3"
chromium.pkg-path = "chromium"
chromium.systems = ["x86_64-linux", "aarch64-linux"]

# SPDX to Mermaid converter CLI tool from flox catalog
spdx-to-mermaid.pkg-path = "flox/spdx-to-mermaid"
spdx-to-mermaid.systems = ["x86_64-linux"]


## Environment Variables ---------------------------------------------
##  ... available for use in the activated environment
##      as well as [hook], [profile] scripts and [services] below.
## -------------------------------------------------------------------
[vars]
# INTRO_MESSAGE = "It's gettin' Flox in here"


## Activation Hook ---------------------------------------------------
##  ... run by _bash_ shell when you run 'flox activate'.
## -------------------------------------------------------------------
[hook]
# on-activate = '''
#   # -> Set variables, create files and directories
#   # -> Perform initialization steps, e.g. create a python venv
#   # -> Useful environment variables:
#   #      - FLOX_ENV_PROJECT=/home/user/example
#   #      - FLOX_ENV=/home/user/example/.flox/run
#   #      - FLOX_ENV_CACHE=/home/user/example/.flox/cache
# '''


## Profile script ----------------------------------------------------
## ... sourced by _your shell_ when you run 'flox activate'.
## -------------------------------------------------------------------
[profile]
common = '''
  # SPDX Viewer Functions

  # Show SPDX file as interactive SVG diagram in browser
  spdx-show() {
    if [ $# -eq 0 ]; then
      echo "Usage: spdx-show <spdx-file> [options]"
      echo "Example: spdx-show file.spdx.json --compact --max-packages 10"
      return 1
    fi

    local spdx_file="$1"
    shift
    local extra_args="$@"

    # Resolve to absolute path
    spdx_file=$(realpath "$spdx_file")

    # Create temp file for mermaid
    local temp_base=$(mktemp)
    local mmd_file="${temp_base}.mmd"
    mv "$temp_base" "$mmd_file"

    local svg_file="$FLOX_ENV_PROJECT/diagram.svg"
    local config_path="$FLOX_ENV_PROJECT/mermaid-config.json"

    # Start HTTP server if not running
    if ! lsof -i:3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
      echo "Starting HTTP server..."
      flox services start http-server
      sleep 1
    fi

    # Generate mermaid diagram
    spdx-to-mermaid "$spdx_file" $extra_args > "$mmd_file"

    # Convert to SVG
    mmdc -i "$mmd_file" -o "$svg_file" --configFile "$config_path" -p "$FLOX_ENV_PROJECT/puppeteer-config.json"

    # Open in browser
    CHROME_DEVEL_SANDBOX="" chromium --no-sandbox "http://localhost:3000/viewer.html"

    # Cleanup
    rm -f "$mmd_file"
  }

  # Convert SPDX to SVG file
  spdx-svg() {
    if [ $# -eq 0 ]; then
      echo "Usage: spdx-svg <spdx-file> [output.svg] [options]"
      echo "Example: spdx-svg file.spdx.json diagram.svg --compact"
      return 1
    fi

    local spdx_file="$1"
    local output="${2:-diagram.svg}"
    shift 2 2>/dev/null || shift 1
    local extra_args="$@"

    # Create temp file
    local temp_base=$(mktemp)
    local mmd_file="${temp_base}.mmd"
    mv "$temp_base" "$mmd_file"

    # Generate and convert
    spdx-to-mermaid "$spdx_file" $extra_args > "$mmd_file"
    mmdc -i "$mmd_file" -o "$output" --configFile "$FLOX_ENV_PROJECT/mermaid-config.json"
    rm -f "$mmd_file"

    echo "Created $output"
  }

  # Start HTTP server
  spdx-serve() {
    flox services start http-server
    echo "HTTP server started on http://localhost:3000"
  }

  # Stop all services
  spdx-stop() {
    flox services stop
  }

  echo "SPDX Viewer environment activated!"
  echo ""
  echo "Available commands:"
  echo "  spdx-show <file>         - View SPDX file as interactive diagram"
  echo "  spdx-svg <file> [out]    - Convert SPDX to SVG file"
  echo "  spdx-to-mermaid <file>   - Convert SPDX to Mermaid (stdout)"
  echo "  spdx-serve               - Start HTTP server"
  echo "  spdx-stop                - Stop services"
  echo ""
'''


## Services ---------------------------------------------------------
##  $ flox services start             <- Starts all services
##  $ flox services status            <- Status of running services
##  $ flox activate --start-services  <- Activates & starts all
## ------------------------------------------------------------------
[services]
# HTTP server for viewing SPDX diagrams
http-server.command = "cd $FLOX_ENV_PROJECT && python3 -m http.server 3000"


## Include ----------------------------------------------------------
## ... environments to create a composed environment
## ------------------------------------------------------------------
[include]
# environments = [
#     { dir = "../common" }
# ]


## Build and publish your own packages ------------------------------
##  This environment is for visualization only, no builds needed
## ------------------------------------------------------------------
[build]


## Other Environment Options -----------------------------------------
[options]
# Systems that environment is compatible with
# systems = [
#   "aarch64-darwin",
#   "aarch64-linux",
#   "x86_64-darwin",
#   "x86_64-linux",
# ]
# Uncomment to disable CUDA detection.
# cuda-detection = false
