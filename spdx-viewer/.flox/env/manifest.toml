## Flox Environment Manifest -----------------------------------------
##
##   _Everything_ you need to know about the _manifest_ is here:
##
##   https://flox.dev/docs/reference/command-reference/manifest.toml/
##
## -------------------------------------------------------------------
# Flox manifest version managed by Flox CLI
version = 1


## Install Packages --------------------------------------------------
##  $ flox install gum  <- puts a package in [install] section below
##  $ flox search gum   <- search for a package
##  $ flox show gum     <- show all versions of a package
## -------------------------------------------------------------------
[install]
mermaid-cli.pkg-path = "mermaid-cli"
python3.pkg-path = "python3"
chromium.pkg-path = "chromium"
chromium.systems = ["x86_64-linux", "aarch64-linux"]

# SPDX to Mermaid converter CLI tool from flox catalog
spdx-to-mermaid.pkg-path = "flox/spdx-to-mermaid"
spdx-to-mermaid.systems = ["x86_64-linux"]


## Environment Variables ---------------------------------------------
##  ... available for use in the activated environment
##      as well as [hook], [profile] scripts and [services] below.
## -------------------------------------------------------------------
[vars]
# INTRO_MESSAGE = "It's gettin' Flox in here"


## Activation Hook ---------------------------------------------------
##  ... run by _bash_ shell when you run 'flox activate'.
## -------------------------------------------------------------------
[hook]
on-activate = '''
  # Create viewer assets if they don't exist
  if [ ! -f "$FLOX_ENV_PROJECT/viewer.html" ]; then
    cat > "$FLOX_ENV_PROJECT/viewer.html" << 'EOF_VIEWER'
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SVG Viewer</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#111; }
    iframe { width:100%; height:100%; border:none; }
    .hud {
      position:fixed; top:10px; left:10px; z-index:10;
      font:14px system-ui; color:#eee; background:#000a; padding:6px 8px; border-radius:8px;
    }
    button { margin-right:6px; }
  </style>
</head>
<body>
  <div class="hud">
    <button id="zin">+</button>
    <button id="zout">âˆ’</button>
    <button id="reset">reset</button>
    <span id="zread">100.0%</span>
  </div>

  <iframe id="svgFrame" src="diagram.svg"></iframe>

  <script>
    const frame = document.getElementById('svgFrame');
    const zread = document.getElementById('zread');
    let state = { scale: 1, x: 0, y: 0 };
    let svg, g;

    function apply() {
      if (!g) return;
      g.setAttribute('transform', `translate(${state.x},${state.y}) scale(${state.scale})`);
      zread.textContent = (state.scale * 100).toFixed(1) + '%';
    }

    frame.addEventListener('load', () => {
      try {
        svg = frame.contentDocument || frame.contentWindow.document;
        console.log('Frame loaded, document:', svg);

        if (!svg) {
          console.error('Cannot access frame document');
          zread.textContent = 'Error: Cannot access SVG';
          return;
        }

        const root = svg.documentElement;
        console.log('SVG root:', root);

        // Wrap all contents in a group
        g = svg.createElementNS('http://www.w3.org/2000/svg', 'g');
        while (root.firstChild) {
          g.appendChild(root.firstChild);
        }
        root.appendChild(g);

        apply();

        let dragging = false, lastX = 0, lastY = 0;

        // Zoom
        root.addEventListener('wheel', (e) => {
          e.preventDefault();
          const factor = e.deltaY < 0 ? 1.12 : 0.89;

          // cursor position in screen coords (relative to iframe content)
          const cx = e.clientX;
          const cy = e.clientY;

          // adjust translation so point under cursor stays put
          state.x = cx - factor * (cx - state.x);
          state.y = cy - factor * (cy - state.y);
          state.scale *= factor;

          apply();
        }, { passive: false });

        // Pan
        root.addEventListener('mousedown', (e) => {
          dragging = true;
          lastX = e.clientX;
          lastY = e.clientY;
          e.preventDefault();
        });

        root.addEventListener('mousemove', (e) => {
          if (!dragging) return;
          // Scale pan speed by current zoom level for more responsive panning
          const panSpeed = Math.max(1, state.scale * 2);
          state.x += (e.clientX - lastX) * panSpeed;
          state.y += (e.clientY - lastY) * panSpeed;
          lastX = e.clientX;
          lastY = e.clientY;
          apply();
        });

        root.addEventListener('mouseup', () => { dragging = false; });
        root.addEventListener('mouseleave', () => { dragging = false; });

      } catch(err) {
        console.error('Error accessing frame:', err);
        zread.textContent = 'Error: ' + err.message;
      }
    });

    // Buttons
    document.getElementById('zin').onclick = () => { state.scale *= 1.25; apply(); };
    document.getElementById('zout').onclick = () => { state.scale /= 1.25; apply(); };
    document.getElementById('reset').onclick = () => { state = {scale:1,x:0,y:0}; apply(); };
  </script>
</body>
</html>
EOF_VIEWER
  fi

  if [ ! -f "$FLOX_ENV_PROJECT/mermaid-config.json" ]; then
    cat > "$FLOX_ENV_PROJECT/mermaid-config.json" << 'EOF_MERMAID'
{
  "maxTextSize": 1000000,
  "maxEdges": 10000,
  "flowchart": { "htmlLabels": false },
  "sequence": { "htmlLabels": false },
  "class": { "htmlLabels": false },
  "state": { "htmlLabels": false },
  "er": { "htmlLabels": false },
  "gantt": { "htmlLabels": false },
  "journey": { "htmlLabels": false },
  "mindmap": { "htmlLabels": false },
  "timeline": { "htmlLabels": false },
  "htmlLabels": false
}
EOF_MERMAID
  fi

  if [ ! -f "$FLOX_ENV_PROJECT/puppeteer-config.json" ]; then
    cat > "$FLOX_ENV_PROJECT/puppeteer-config.json" << 'EOF_PUPPETEER'
{
  "args": ["--no-sandbox", "--disable-setuid-sandbox"]
}
EOF_PUPPETEER
  fi
'''


## Profile script ----------------------------------------------------
## ... sourced by _your shell_ when you run 'flox activate'.
## -------------------------------------------------------------------
[profile]
common = '''
  # SPDX Viewer Functions

  # Show SPDX file as interactive SVG diagram in browser
  spdx-show() {
    if [ $# -eq 0 ]; then
      echo "Usage: spdx-show <spdx-file> [options]"
      echo "Example: spdx-show file.spdx.json --compact --max-packages 10"
      return 1
    fi

    local spdx_file="$1"
    shift
    local extra_args="$@"

    # Resolve to absolute path
    spdx_file=$(realpath "$spdx_file")

    # Create temp file for mermaid
    local temp_base=$(mktemp)
    local mmd_file="${temp_base}.mmd"
    mv "$temp_base" "$mmd_file"

    local svg_file="$FLOX_ENV_PROJECT/diagram.svg"
    local config_path="$FLOX_ENV_PROJECT/mermaid-config.json"

    # Start HTTP server if not running
    if ! lsof -i:3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
      echo "Starting HTTP server..."
      flox services start http-server
      sleep 1
    fi

    # Generate mermaid diagram
    spdx-to-mermaid "$spdx_file" $extra_args > "$mmd_file"

    # Convert to SVG
    mmdc -i "$mmd_file" -o "$svg_file" --configFile "$config_path" -p "$FLOX_ENV_PROJECT/puppeteer-config.json"

    # Open in browser
    CHROME_DEVEL_SANDBOX="" chromium --no-sandbox "http://localhost:3000/viewer.html"

    # Cleanup
    rm -f "$mmd_file"
  }

  # Convert SPDX to SVG file
  spdx-svg() {
    if [ $# -eq 0 ]; then
      echo "Usage: spdx-svg <spdx-file> [output.svg] [options]"
      echo "Example: spdx-svg file.spdx.json diagram.svg --compact"
      return 1
    fi

    local spdx_file="$1"
    local output="${2:-diagram.svg}"
    shift 2 2>/dev/null || shift 1
    local extra_args="$@"

    # Create temp file
    local temp_base=$(mktemp)
    local mmd_file="${temp_base}.mmd"
    mv "$temp_base" "$mmd_file"

    # Generate and convert
    spdx-to-mermaid "$spdx_file" $extra_args > "$mmd_file"
    mmdc -i "$mmd_file" -o "$output" --configFile "$FLOX_ENV_PROJECT/mermaid-config.json"
    rm -f "$mmd_file"

    echo "Created $output"
  }

  # Start HTTP server
  spdx-serve() {
    flox services start http-server
    echo "HTTP server started on http://localhost:3000"
  }

  # Stop all services
  spdx-stop() {
    flox services stop
  }

  echo "SPDX Viewer environment activated!"
  echo ""
  echo "Available commands:"
  echo "  spdx-show <file>         - View SPDX file as interactive diagram"
  echo "  spdx-svg <file> [out]    - Convert SPDX to SVG file"
  echo "  spdx-to-mermaid <file>   - Convert SPDX to Mermaid (stdout)"
  echo "  spdx-serve               - Start HTTP server"
  echo "  spdx-stop                - Stop services"
  echo ""
'''


## Services ---------------------------------------------------------
##  $ flox services start             <- Starts all services
##  $ flox services status            <- Status of running services
##  $ flox activate --start-services  <- Activates & starts all
## ------------------------------------------------------------------
[services]
# HTTP server for viewing SPDX diagrams
http-server.command = "cd $FLOX_ENV_PROJECT && python3 -m http.server 3000"


## Include ----------------------------------------------------------
## ... environments to create a composed environment
## ------------------------------------------------------------------
[include]
# environments = [
#     { dir = "../common" }
# ]


## Build and publish your own packages ------------------------------
##  This environment is for visualization only, no builds needed
## ------------------------------------------------------------------
[build]


## Other Environment Options -----------------------------------------
[options]
# Systems that environment is compatible with
# systems = [
#   "aarch64-darwin",
#   "aarch64-linux",
#   "x86_64-darwin",
#   "x86_64-linux",
# ]
# Uncomment to disable CUDA detection.
# cuda-detection = false
